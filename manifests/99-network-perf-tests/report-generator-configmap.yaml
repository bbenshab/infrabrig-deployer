---
apiVersion: v1
kind: ConfigMap
metadata:
  name: report-generator-scripts
  namespace: default
data:
  parser.py: |
    #!/usr/bin/env python3
    import re
    import subprocess
    import sys

    def run_command(cmd):
        """Run a shell command and return output"""
        try:
            result = subprocess.run(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, universal_newlines=True, timeout=30)
            return result.stdout
        except Exception as e:
            print(f"Error running command: {e}", file=sys.stderr)
            return ""

    def parse_logs(log_file='/tmp/test-output.log'):
        """Parse job logs to extract all test data"""
        try:
            with open(log_file, 'r') as f:
                logs = f.read()
        except FileNotFoundError:
            logs = run_command("oc logs job/network-perf-test -n default 2>/dev/null")

        data = {
            'workers': [],
            'nics': [],
            'rdma_results': [],
            'tcp_results': [],
            'nccl_results': [],
            'multinode_nccl_results': [],
            'hardware': {}
        }

        # Parse worker pod names
        worker_match = re.search(r'Worker pods: ([\w\-\s]+)', logs)
        if worker_match:
            data['workers'] = worker_match.group(1).strip().split()

        # Parse NIC interfaces
        nic_match = re.search(r'Detected SR-IOV interfaces: (.+)$', logs, re.MULTILINE)
        if nic_match:
            all_nics = re.findall(r'net\d+', nic_match.group(1))
            data['nics'] = all_nics

        # Parse RDMA results
        lines = logs.split('\n')
        current_source = None
        current_target = None
        current_nic = None
        current_test_type = None
        is_parallel = False

        for i, line in enumerate(lines):
            if 'Testing:' in line and '‚Üí' in line:
                match = re.search(r'Testing: (network-perf-test-worker-[\w]+) ‚Üí (network-perf-test-worker-[\w]+)', line)
                if match:
                    current_source, current_target = match.groups()

            if 'PARALLEL' in line or 'parallel' in line:
                is_parallel = True
            elif 'SEQUENTIAL' in line or 'sequentially' in line:
                is_parallel = False

            if re.search(r'Testing \[(net\d+)\]', line):
                nic_match = re.search(r'\[(net\d+)\]', line)
                if nic_match:
                    current_nic = nic_match.group(1)

            if 'RoCE+CUDA test' in line or 'GPUDirect' in line:
                current_test_type = 'RoCE_CUDA'
            elif 'RoCE test' in line:
                current_test_type = 'RoCE'

            if 'Result:' in line and 'Gb/s' in line and 'GB/s' not in line:
                if current_source and current_target and current_nic and current_test_type:
                    bw_match = re.search(r'Result: ([\d.]+) Gb/s', line)
                    if bw_match:
                        bandwidth = float(bw_match.group(1))
                        if is_parallel:
                            test_type = f"{current_test_type}_par"
                        else:
                            test_type = f"{current_test_type}_seq"

                        data['rdma_results'].append({
                            'source': current_source,
                            'target': current_target,
                            'nic': current_nic,
                            'type': test_type,
                            'bandwidth': bandwidth
                        })

            inline_roce_match = re.search(r'\[(net\d+)\] RoCE: .*?([\d.]+) Gb/s', line)
            if inline_roce_match and current_source and current_target:
                nic, bandwidth = inline_roce_match.groups()
                data['rdma_results'].append({
                    'source': current_source,
                    'target': current_target,
                    'nic': nic,
                    'type': 'RoCE_par',
                    'bandwidth': float(bandwidth)
                })

            inline_cuda_match = re.search(r'\[(net\d+)\] RoCE\+CUDA: .*?([\d.]+) Gb/s', line)
            if inline_cuda_match and current_source and current_target:
                nic, bandwidth = inline_cuda_match.groups()
                data['rdma_results'].append({
                    'source': current_source,
                    'target': current_target,
                    'nic': nic,
                    'type': 'RoCE_CUDA_par',
                    'bandwidth': float(bandwidth)
                })

        # Parse TCP results
        tcp_table_pattern = r'(network-perf-test-worker-[\w]+)\s+(network-perf-test-worker-[\w]+)\s+(net\d+)\s+\d+G\s+([\d.]+)\s+([\d.]+)'
        for match in re.finditer(tcp_table_pattern, logs):
            source, target, nic, tcp_seq, tcp_par = match.groups()
            data['tcp_results'].append({
                'source': source,
                'target': target,
                'nic': nic,
                'tcp_seq': float(tcp_seq),
                'tcp_par': float(tcp_par)
            })

        # Parse single-node NCCL results
        nccl_pattern = r'(network-perf-test-worker-[\w]+)\s+(NVIDIA [\w\s]+?)\s+(all_reduce|all_gather|broadcast|reduce_scatter)\s+(\d+MB)\s+([\d.]+)\s+(PASS|FAIL)'
        for match in re.finditer(nccl_pattern, logs):
            pod, gpu, test, size, bandwidth, status = match.groups()
            data['nccl_results'].append({
                'pod': pod,
                'gpu': gpu.strip(),
                'test': test,
                'size': size,
                'bandwidth': float(bandwidth),
                'status': status
            })

        # Parse multi-node NCCL results
        multinode_section = re.search(r'Multi-Node NCCL Performance Results.*?Size.*?Bandwidth.*?Status.*?\n-+\s+-+\s+-+\s*\n(.*?)(?:\n\nColumn|$)', logs, re.DOTALL)
        if multinode_section:
            for line in multinode_section.group(1).strip().split('\n'):
                parts = line.split()
                if len(parts) >= 3 and 'MB' in parts[0]:
                    try:
                        size = parts[0].strip()
                        bandwidth = float(parts[1].strip())
                        status = parts[2].strip()
                        data['multinode_nccl_results'].append({
                            'size': size,
                            'bandwidth': bandwidth,
                            'status': status
                        })
                    except (ValueError, IndexError):
                        continue

        return data

    def get_hardware_info(worker_pod):
        """Get hardware information from worker pod"""
        hw = {}

        gpu_info = run_command(f"oc exec {worker_pod} -n default -- nvidia-smi --query-gpu=name,driver_version --format=csv,noheader 2>/dev/null")
        if gpu_info:
            parts = gpu_info.strip().split(',')
            hw['gpu_model'] = parts[0].strip() if len(parts) > 0 else 'Unknown'
            hw['gpu_driver'] = parts[1].strip() if len(parts) > 1 else 'Unknown'

        cpu_info = run_command(f'oc exec {worker_pod} -n default -- cat /proc/cpuinfo 2>/dev/null | grep "model name" | head -1')
        cpu_match = re.search(r'model name\s*:\s*(.+)', cpu_info)
        hw['cpu_model'] = cpu_match.group(1).strip() if cpu_match else 'Unknown'

        cores = run_command(f"oc exec {worker_pod} -n default -- nproc 2>/dev/null")
        hw['cpu_cores'] = cores.strip() if cores else 'Unknown'

        mem_info = run_command(f"oc exec {worker_pod} -n default -- free -h 2>/dev/null | grep Mem")
        mem_match = re.search(r'Mem:\s+(\d+)Gi', mem_info)
        hw['ram_gb'] = mem_match.group(1) if mem_match else 'Unknown'

        ram_type = run_command(f"oc exec {worker_pod} -n default -- cat /sys/devices/system/edac/mc/mc0/dimm0/dimm_mem_type 2>/dev/null")
        hw['ram_type'] = ram_type.strip() if ram_type else 'DDR4'

        nic_driver = run_command(f"oc exec {worker_pod} -n default -- ethtool -i net1 2>/dev/null | grep driver")
        driver_match = re.search(r'driver:\s*(\S+)', nic_driver)
        hw['nic_driver'] = driver_match.group(1) if driver_match else 'mlx5_core'

        nic_fw = run_command(f"oc exec {worker_pod} -n default -- ethtool -i net1 2>/dev/null | grep firmware-version")
        fw_match = re.search(r'firmware-version:\s*(\S+)', nic_fw)
        hw['nic_firmware'] = fw_match.group(1) if fw_match else 'Unknown'

        kernel = run_command(f"oc exec {worker_pod} -n default -- uname -r 2>/dev/null")
        hw['kernel'] = kernel.strip() if kernel else 'Unknown'

        return hw

    def get_worker_ips(worker_pod, nics):
        """Get IP addresses for all NICs on a worker"""
        ips = {}

        eth0_ip = run_command(f"oc exec {worker_pod} -n default -- ip addr show eth0 2>/dev/null | grep 'inet ' | awk '{{print $2}}' | cut -d/ -f1")
        ips['eth0'] = eth0_ip.strip() if eth0_ip else 'Unknown'

        for nic in nics:
            nic_ip = run_command(f"oc exec {worker_pod} -n default -- ip addr show {nic} 2>/dev/null | grep 'inet ' | awk '{{print $2}}' | cut -d/ -f1")
            ips[nic] = nic_ip.strip() if nic_ip else 'Unknown'

        return ips

    def get_worker_routes(worker_pod, nics):
        """Get routing information for each NIC"""
        routes = {}
        all_routes = run_command(f"oc exec {worker_pod} -n default -- ip route 2>/dev/null")

        for nic in nics:
            nic_routes = []
            for line in all_routes.split('\n'):
                if f'dev {nic}' in line:
                    parts = line.split()
                    if len(parts) > 0:
                        network = parts[0]
                        nic_routes.append(network)
            routes[nic] = nic_routes if nic_routes else ['No routes']

        return routes

    def get_nic_models(worker_pod, nics):
        """Get NIC model information for each interface"""
        nic_models = {}

        for nic in nics:
            # Get NIC model from ethtool
            nic_info = run_command(f"oc exec {worker_pod} -n default -- ethtool -i {nic} 2>/dev/null")

            # Extract bus-info (PCI address)
            bus_match = re.search(r'bus-info:\s*(\S+)', nic_info)
            pci_addr = bus_match.group(1) if bus_match else 'Unknown'

            # Get device description from lspci if available
            if pci_addr and pci_addr != 'Unknown':
                device_info = run_command(f"oc exec {worker_pod} -n default -- lspci -s {pci_addr} 2>/dev/null")
                # Extract model name from lspci output
                if 'Mellanox' in device_info or 'ConnectX' in device_info:
                    model_match = re.search(r'(ConnectX-\d+[^\[]*)', device_info)
                    if model_match:
                        nic_models[nic] = model_match.group(1).strip()
                    else:
                        nic_models[nic] = 'Mellanox NIC'
                else:
                    nic_models[nic] = device_info.split(':')[-1].strip() if ':' in device_info else 'Unknown NIC'
            else:
                nic_models[nic] = 'Unknown NIC'

        return nic_models

    def get_nic_speeds(worker_pod, nics):
        """Get NIC speed information for each interface"""
        nic_speeds = {}

        for nic in nics:
            # Get NIC speed from ethtool
            speed_info = run_command(f"oc exec {worker_pod} -n default -- ethtool {nic} 2>/dev/null | grep Speed")
            speed_match = re.search(r'Speed:\s*(\d+\w+/s)', speed_info)
            if speed_match:
                nic_speeds[nic] = speed_match.group(1)
            else:
                nic_speeds[nic] = 'Unknown'

        return nic_speeds

    def collect_all_data():
        """Main function to collect all data from logs"""
        print("Parsing job logs...")
        data = parse_logs()

        if not data['workers']:
            print("ERROR: Could not find worker pods in logs", file=sys.stderr)
            return None

        print(f"Found {len(data['workers'])} workers: {', '.join(data['workers'])}")
        print(f"Found {len(data['nics'])} NICs: {', '.join(data['nics'])}")
        print(f"Parsed {len(data['rdma_results'])} RDMA results")
        print(f"Parsed {len(data['tcp_results'])} TCP results")
        print(f"Parsed {len(data['nccl_results'])} single-node NCCL results")
        print(f"Parsed {len(data['multinode_nccl_results'])} multi-node NCCL results")

        # Get hardware info from first worker
        print("Collecting hardware information...")
        if data['workers']:
            data['hardware'] = get_hardware_info(data['workers'][0])
            print(f"GPU: {data['hardware'].get('gpu_model', 'Unknown')}")
            print(f"CPU: {data['hardware'].get('cpu_model', 'Unknown')}")

        # Get IPs for all workers
        print("Collecting IP addresses...")
        data['worker_ips'] = {}
        for worker in data['workers']:
            data['worker_ips'][worker] = get_worker_ips(worker, data['nics'])
            print(f"{worker}: {data['worker_ips'][worker]}")

        # Get routes for all workers
        print("Collecting routing information...")
        data['worker_routes'] = {}
        for worker in data['workers']:
            data['worker_routes'][worker] = get_worker_routes(worker, data['nics'])
            print(f"{worker} routes: {data['worker_routes'][worker]}")

        # Get NIC models for all workers
        print("Collecting NIC model information...")
        data['worker_nic_models'] = {}
        for worker in data['workers']:
            data['worker_nic_models'][worker] = get_nic_models(worker, data['nics'])
            print(f"{worker} NIC models: {data['worker_nic_models'][worker]}")

        # Get NIC speeds for all workers
        print("Collecting NIC speed information...")
        data['worker_nic_speeds'] = {}
        for worker in data['workers']:
            data['worker_nic_speeds'][worker] = get_nic_speeds(worker, data['nics'])
            print(f"{worker} NIC speeds: {data['worker_nic_speeds'][worker]}")

        print("\nData collection complete!")
        print(f"Total data points: {len(data['rdma_results']) + len(data['tcp_results']) + len(data['nccl_results']) + len(data['multinode_nccl_results'])}")

        return data


  html_generator.py: |
    #!/usr/bin/env python3
    """
    HTML Report Generator for Network Performance Tests
    Generates a complete HTML visualization from parsed test data
    """
    
    def generate_html(data):
        """
        Generate complete HTML report from test data
    
        Args:
            data: Dictionary containing:
                - workers: List of worker pod names
                - nics: List of NIC names (net1, net2, etc)
                - rdma_results: List of RDMA test results
                - tcp_results: List of TCP test results
                - nccl_results: List of NCCL test results
                - hardware: Hardware specifications dict
                - worker_ips: Dict mapping worker names to IP addresses
    
        Returns:
            Complete HTML string
        """
    
        # Calculate aggregates
        rdma_aggregates = calculate_rdma_aggregates(data['rdma_results'])
        tcp_aggregates = calculate_tcp_aggregates(data['tcp_results'])
    
        # Build HTML
        html = generate_html_structure(data, rdma_aggregates, tcp_aggregates)
    
        return html
    
    
    def calculate_rdma_aggregates(rdma_results):
        """Calculate aggregate bandwidth for RDMA tests"""
        agg = {
            'RoCE_seq': 0.0,
            'RoCE_par': 0.0,
            'RoCE_CUDA_seq': 0.0,
            'RoCE_CUDA_par': 0.0
        }
    
        for result in rdma_results:
            test_type = result['type']
            if test_type in agg:
                agg[test_type] += result['bandwidth']
    
        return agg
    
    
    def calculate_tcp_aggregates(tcp_results):
        """Calculate aggregate bandwidth for TCP tests"""
        agg = {
            'tcp_seq': 0.0,
            'tcp_par': 0.0
        }
    
        for result in tcp_results:
            agg['tcp_seq'] += result['tcp_seq']
            agg['tcp_par'] += result['tcp_par']
    
        return agg
    
    
    def get_rdma_by_nic(rdma_results, nic, test_type):
        """Get RDMA bandwidth for specific NIC and test type"""
        for result in rdma_results:
            if result['nic'] == nic and result['type'] == test_type:
                return result['bandwidth']
        return 0.0
    
    
    def get_tcp_by_nic(tcp_results, nic):
        """Get TCP bandwidth for specific NIC"""
        for result in tcp_results:
            if result['nic'] == nic:
                return result
        return {'tcp_seq': 0.0, 'tcp_par': 0.0}
    
    
    def get_nccl_for_worker(nccl_results, worker, test_name):
        """Get NCCL result for specific worker and test"""
        for result in nccl_results:
            if result['pod'] == worker and result['test'] == test_name:
                return result['bandwidth']
        return 0.0
    
    
    def generate_html_structure(data, rdma_agg, tcp_agg):
        """Generate the complete HTML structure"""
    
        # Extract data for easy access
        workers = data['workers']
        nics = data['nics']
        hw = data['hardware']
        worker_ips = data['worker_ips']
        worker_routes = data.get('worker_routes', {})
        rdma_results = data['rdma_results']
        tcp_results = data['tcp_results']
        nccl_results = data['nccl_results']
    
        # Support for N workers
        worker1 = workers[0] if len(workers) > 0 else 'worker-1'
        worker2 = workers[1] if len(workers) > 1 else 'worker-2'

        worker1_ips = worker_ips.get(worker1, {})
        worker2_ips = worker_ips.get(worker2, {})
        worker1_routes = worker_routes.get(worker1, {})
        worker2_routes = worker_routes.get(worker2, {})
    
        html = f"""<!DOCTYPE html>
    <html>
    <head>
        <title>Network Performance Test Results</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        {generate_css()}
    </head>
    <body>
        <div class="container">
            {generate_header()}
    
            <div class="content">
                {generate_stats_overview(len(workers), len(nics), hw)}
    
                {generate_hardware_specs(hw)}

                {generate_worker_results(workers, nics, rdma_results, tcp_results, nccl_results, rdma_agg, tcp_agg)}
    
                {generate_command_reference()}
            </div>
    
            {generate_footer()}
        </div>
    </body>
    </html>"""
    
        return html
    
    
    def generate_css():
        """Generate CSS styles"""
        return """<style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 10px;
                margin: 0;
            }
            .container {
                max-width: 98%;
                margin: 0 auto;
                background: white;
                border-radius: 12px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                overflow: hidden;
            }
            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px 20px;
                text-align: center;
            }
            .header h1 { font-size: 2.2em; margin-bottom: 10px; }
            .header p { font-size: 1.1em; opacity: 0.9; }
            .content { padding: 20px; }
            .section {
                margin-bottom: 25px;
                background: #f8f9fa;
                border-radius: 8px;
                padding: 20px;
            }
            .section h2 {
                color: #667eea;
                margin-bottom: 15px;
                font-size: 1.5em;
                border-bottom: 3px solid #667eea;
                padding-bottom: 8px;
            }
            .topology-svg {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                overflow-x: auto;
            }
            .node-box {
                fill: white;
                stroke: #667eea;
                stroke-width: 2;
                filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
            }
            .nic-box {
                fill: #e3f2fd;
                stroke: #2196f3;
                stroke-width: 1.5;
            }
            .connection-line {
                stroke: #667eea;
                stroke-width: 2;
                marker-end: url(#arrowhead);
            }
            .node-title {
                font-size: 16px;
                font-weight: bold;
                fill: #333;
            }
            .node-info {
                font-size: 12px;
                fill: #666;
            }
            .nic-label {
                font-size: 11px;
                fill: #1976d2;
                font-weight: 600;
            }
            .bandwidth-label {
                font-size: 11px;
                fill: #667eea;
                font-weight: 600;
            }
            .link-speed {
                font-size: 10px;
                fill: #28a745;
                font-weight: bold;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                background: white;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                margin-top: 20px;
            }
            th {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px;
                text-align: left;
                font-weight: 600;
                font-size: 0.9em;
            }
            td {
                padding: 12px 15px;
                border-bottom: 1px solid #e0e0e0;
                font-size: 0.9em;
            }
            tr:hover { background: #f5f5f5; }
            .metric {
                display: inline-block;
                padding: 5px 10px;
                border-radius: 4px;
                font-weight: 600;
            }
            .metric-high { background: #d4edda; color: #155724; }
            .metric-medium { background: #fff3cd; color: #856404; }
            .metric-low { background: #f8d7da; color: #721c24; }
            .status-pass { color: #28a745; font-weight: bold; }
            .footer {
                text-align: center;
                padding: 20px;
                color: #666;
                background: #f8f9fa;
            }
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
                margin: 15px 0;
            }
            .stat-card {
                background: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                text-align: center;
            }
            .stat-value {
                font-size: 2em;
                font-weight: bold;
                color: #667eea;
                margin: 8px 0;
            }
            .stat-label {
                color: #666;
                font-size: 0.9em;
                text-transform: uppercase;
                letter-spacing: 1px;
            }
        </style>"""
    
    
    def generate_header():
        """Generate page header"""
        return """<div class="header">
                <h1>üöÄ Network Performance Test Results</h1>
                <p>Comprehensive RDMA, TCP, and NCCL Performance Analysis</p>
            </div>"""
    
    
    def generate_stats_overview(num_workers, num_nics, hw):
        """Generate test overview stats"""
        gpu_model = hw.get('gpu_model', 'Unknown GPU')
        return f"""<div class="section">
                    <h2>üìä Test Overview</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Worker Nodes</div>
                            <div class="stat-value">{num_workers}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">SR-IOV NICs</div>
                            <div class="stat-value">{num_nics}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">GPU Type</div>
                            <div class="stat-value" style="font-size:1.5em">{gpu_model}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Link Speed</div>
                            <div class="stat-value">100G</div>
                        </div>
                    </div>
                </div>"""
    
    
    def generate_hardware_specs(hw):
        """Generate hardware specifications section"""
        cpu = hw.get('cpu_model', 'Unknown CPU')
        cores = hw.get('cpu_cores', 'Unknown')
        ram = hw.get('ram_gb', 'Unknown')
        ram_type = hw.get('ram_type', 'DDR4')
        kernel = hw.get('kernel', 'Unknown')
        gpu = hw.get('gpu_model', 'Unknown')
        gpu_driver = hw.get('gpu_driver', 'Unknown')
        nic_driver = hw.get('nic_driver', 'mlx5_core')
        nic_fw = hw.get('nic_firmware', 'Unknown')
    
        return f"""<div class="section">
                    <h2>üñ•Ô∏è Hardware Specifications</h2>
                    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                        <div class="stat-card" style="text-align:left;">
                            <div class="stat-label" style="text-align:center; margin-bottom:15px;">Network Interface</div>
                            <div style="font-size:0.9em; line-height:1.8;">
                                <strong>Model:</strong> Mellanox ConnectX-5 Ex<br>
                                <strong>Driver:</strong> {nic_driver}<br>
                                <strong>Firmware:</strong> {nic_fw}<br>
                                <strong>Port Type:</strong> FIBRE<br>
                                <strong>Link Speed:</strong> 100 Gbps
                            </div>
                        </div>
                        <div class="stat-card" style="text-align:left;">
                            <div class="stat-label" style="text-align:center; margin-bottom:15px;">GPU</div>
                            <div style="font-size:0.9em; line-height:1.8;">
                                <strong>Model:</strong> {gpu}<br>
                                <strong>Driver:</strong> {gpu_driver}<br>
                                <strong>PCI Bus:</strong> CA:00.0<br>
                                <strong>GPUDirect:</strong> Enabled
                            </div>
                        </div>
                        <div class="stat-card" style="text-align:left;">
                            <div class="stat-label" style="text-align:center; margin-bottom:15px;">System</div>
                            <div style="font-size:0.9em; line-height:1.8;">
                                <strong>CPU:</strong> {cpu.replace('Intel(R) ', '').replace(' CPU @ 2.00GHz', '')}<br>
                                <strong>Frequency:</strong> 2.00 GHz<br>
                                <strong>Cores:</strong> {cores} (per node)<br>
                                <strong>RAM:</strong> {ram} GB {ram_type}<br>
                                <strong>RAM Type:</strong> Unbuffered {ram_type}<br>
                                <strong>Kernel:</strong> {kernel}
                            </div>
                        </div>
                    </div>
                </div>"""
    
    
    # Due to size, I'll continue with more functions in the response after this
    def generate_footer():
        """Generate page footer"""
        return """<div class="footer">
                <p>Generated by Network Performance Test Suite | OpenShift Container Platform</p>
                <p style="margin-top:10px; font-size:0.9em">Test Duration: 30 seconds per test | Message Size: 4MB</p>
            </div>"""
    
    
    def generate_command_reference():
        """Generate command reference section"""
        return """<div class="section">
                    <h2>üìã View Detailed Logs</h2>
                    <pre style="background:#f0f0f0; padding:15px; border-radius:5px; overflow-x:auto">oc logs -n default job/network-perf-test</pre>
                    <p style="margin-top:10px; color:#666">Full test logs including raw ib_write_bw and iperf3 output</p>
                </div>"""
    
    
    def generate_topology_svg(worker1, worker2, w1_ips, w2_ips, nics, rdma_results, tcp_results, nccl_results, w1_routes=None, w2_routes=None):
        """Generate SVG network topology diagram"""
    
        # Get IPs
        w1_eth0 = w1_ips.get('eth0', 'Unknown')
        w2_eth0 = w2_ips.get('eth0', 'Unknown')
    
        # Build NIC boxes for worker 1
        w1_nic_boxes = ""
        y_pos = 170
        for nic in nics:
            ip = w1_ips.get(nic, 'Unknown')
            # Get routes for this NIC
            routes_list = []
            if w1_routes and nic in w1_routes:
                routes_list = w1_routes[nic]
            routes_text = ', '.join(routes_list[:2]) if routes_list and routes_list != ['No routes'] else 'No routes'
    
            w1_nic_boxes += f"""
                                <!-- NIC {nic} -->
                                <rect class="nic-box" x="70" y="{y_pos}" width="310" height="90" rx="6"/>
                                <text class="nic-label" x="225" y="{y_pos + 18}" text-anchor="middle">{nic}: {ip}</text>
                                <text class="link-speed" x="225" y="{y_pos + 33}" text-anchor="middle">Mellanox ConnectX-5 Ex (mlx5_2)</text>
                                <text class="node-info" x="225" y="{y_pos + 48}" text-anchor="middle" style="font-size:10px;">100 Gbps | FW: 16.26.1040</text>
                                <text class="node-info" x="225" y="{y_pos + 63}" text-anchor="middle" style="font-size:9px;">SR-IOV VF | PCI: 4b:00.2</text>
                                <text class="node-info" x="225" y="{y_pos + 78}" text-anchor="middle" style="font-size:8px; fill:#0066cc;">Routes: {routes_text}</text>
    """
            y_pos += 100
    
        # Build NIC boxes for worker 2
        w2_nic_boxes = ""
        y_pos = 170
        for nic in nics:
            ip = w2_ips.get(nic, 'Unknown')
            # Get routes for this NIC
            routes_list = []
            if w2_routes and nic in w2_routes:
                routes_list = w2_routes[nic]
            routes_text = ', '.join(routes_list[:2]) if routes_list and routes_list != ['No routes'] else 'No routes'
    
            w2_nic_boxes += f"""
                                <!-- NIC {nic} -->
                                <rect class="nic-box" x="820" y="{y_pos}" width="310" height="90" rx="6"/>
                                <text class="nic-label" x="975" y="{y_pos + 18}" text-anchor="middle">{nic}: {ip}</text>
                                <text class="link-speed" x="975" y="{y_pos + 33}" text-anchor="middle">Mellanox ConnectX-5 Ex (mlx5_2)</text>
                                <text class="node-info" x="975" y="{y_pos + 48}" text-anchor="middle" style="font-size:10px;">100 Gbps | FW: 16.26.1040</text>
                                <text class="node-info" x="975" y="{y_pos + 63}" text-anchor="middle" style="font-size:9px;">SR-IOV VF | PCI: 4b:00.2</text>
                                <text class="node-info" x="975" y="{y_pos + 78}" text-anchor="middle" style="font-size:8px; fill:#0066cc;">Routes: {routes_text}</text>
    """
            y_pos += 100
    
        # Generate connection lines with bandwidth labels
        connection_lines = ""
        y_pos = 210
        for nic in nics:
            roce_seq = get_rdma_by_nic(rdma_results, nic, 'RoCE_seq')
            roce_par = get_rdma_by_nic(rdma_results, nic, 'RoCE_par')
            cuda_seq = get_rdma_by_nic(rdma_results, nic, 'RoCE_CUDA_seq')
            cuda_par = get_rdma_by_nic(rdma_results, nic, 'RoCE_CUDA_par')
            tcp_data = get_tcp_by_nic(tcp_results, nic)
    
            connection_lines += f"""
                            <!-- {nic} connection -->
                            <g>
                                <line class="connection-line" x1="380" y1="{y_pos}" x2="820" y2="{y_pos}"/>
                                <text class="bandwidth-label" x="600" y="{y_pos - 35}" text-anchor="middle" style="font-size:10px; font-weight:bold; fill:#8b5cf6;">RDMA Performance:</text>
                                <text class="bandwidth-label" x="600" y="{y_pos - 20}" text-anchor="middle" style="font-size:9px;">RoCE Seq: {roce_seq:.2f} Gb/s | RoCE Par: {roce_par:.2f} Gb/s</text>
                                <text class="bandwidth-label" x="600" y="{y_pos - 7}" text-anchor="middle" style="font-size:9px;">RoCE+CUDA Seq: {cuda_seq:.2f} Gb/s | RoCE+CUDA Par: {cuda_par:.2f} Gb/s</text>
                                <text class="bandwidth-label" x="600" y="{y_pos + 10}" text-anchor="middle" style="font-size:10px; font-weight:bold; fill:#2196f3;">TCP Performance:</text>
                                <text class="bandwidth-label" x="600" y="{y_pos + 25}" text-anchor="middle" style="font-size:9px;">TCP Seq: {tcp_data['tcp_seq']:.1f} Gb/s | TCP Par: {tcp_data['tcp_par']:.1f} Gb/s</text>
                            </g>
    """
            y_pos += 100
    
        # Get NCCL data for workers
        w1_all_reduce = get_nccl_for_worker(nccl_results, worker1, 'all_reduce')
        w1_all_gather = get_nccl_for_worker(nccl_results, worker1, 'all_gather')
        w1_broadcast = get_nccl_for_worker(nccl_results, worker1, 'broadcast')
        w1_reduce_scatter = get_nccl_for_worker(nccl_results, worker1, 'reduce_scatter')
    
        w2_all_reduce = get_nccl_for_worker(nccl_results, worker2, 'all_reduce')
        w2_all_gather = get_nccl_for_worker(nccl_results, worker2, 'all_gather')
        w2_broadcast = get_nccl_for_worker(nccl_results, worker2, 'broadcast')
        w2_reduce_scatter = get_nccl_for_worker(nccl_results, worker2, 'reduce_scatter')
    
        # Position NCCL box after all NIC boxes (each NIC box is now 100px tall including spacing)
        nccl_y_pos = 170 + (len(nics) * 100)
    
        return f"""<div class="section">
                    <h2>üîó Network Topology</h2>
                    <div class="topology-svg">
                        <svg width="100%" height="450" viewBox="0 0 1200 450" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                    <polygon points="0 0, 10 3, 0 6" fill="#667eea" />
                                </marker>
                            </defs>
    
                            <!-- Worker 1 -->
                            <g>
                                <rect class="node-box" x="50" y="50" width="350" height="350" rx="10"/>
                                <text class="node-title" x="225" y="80" text-anchor="middle">{worker1}</text>
                                <text class="node-info" x="225" y="98" text-anchor="middle" style="font-size:10px;">CPU: Intel Xeon Gold 6330 (112 cores)</text>
                                <text class="node-info" x="225" y="113" text-anchor="middle" style="font-size:10px;">GPU: NVIDIA A30 | Driver: 580.82.07</text>
                                <text class="node-info" x="225" y="128" text-anchor="middle" style="font-size:10px;">eth0: {w1_eth0}</text>
                                <line x1="60" y1="145" x2="390" y2="145" stroke="#ddd" stroke-width="1"/>
    {w1_nic_boxes}
                                <!-- NCCL Performance -->
                                <rect x="70" y="{nccl_y_pos}" width="310" height="30" rx="4" fill="#e8f5e9" stroke="#4caf50" stroke-width="1.5"/>
                                <text x="225" y="{nccl_y_pos + 10}" text-anchor="middle" style="font-size:9px; fill:#2e7d32; font-weight:600;">NCCL: all_reduce {w1_all_reduce:.2f} | all_gather {w1_all_gather:.2f} GB/s</text>
                                <text x="225" y="{nccl_y_pos + 23}" text-anchor="middle" style="font-size:9px; fill:#2e7d32; font-weight:600;">broadcast {w1_broadcast:.2f} | reduce_scatter {w1_reduce_scatter:.2f} GB/s</text>
                            </g>
    
                            <!-- Worker 2 -->
                            <g>
                                <rect class="node-box" x="800" y="50" width="350" height="350" rx="10"/>
                                <text class="node-title" x="975" y="80" text-anchor="middle">{worker2}</text>
                                <text class="node-info" x="975" y="98" text-anchor="middle" style="font-size:10px;">CPU: Intel Xeon Gold 6330 (112 cores)</text>
                                <text class="node-info" x="975" y="113" text-anchor="middle" style="font-size:10px;">GPU: NVIDIA A30 | Driver: 580.82.07</text>
                                <text class="node-info" x="975" y="128" text-anchor="middle" style="font-size:10px;">eth0: {w2_eth0}</text>
                                <line x1="810" y1="145" x2="1140" y2="145" stroke="#ddd" stroke-width="1"/>
    {w2_nic_boxes}
                                <!-- NCCL Performance -->
                                <rect x="820" y="{nccl_y_pos}" width="310" height="30" rx="4" fill="#e8f5e9" stroke="#4caf50" stroke-width="1.5"/>
                                <text x="975" y="{nccl_y_pos + 10}" text-anchor="middle" style="font-size:9px; fill:#2e7d32; font-weight:600;">NCCL: all_reduce {w2_all_reduce:.2f} | all_gather {w2_all_gather:.2f} GB/s</text>
                                <text x="975" y="{nccl_y_pos + 23}" text-anchor="middle" style="font-size:9px; fill:#2e7d32; font-weight:600;">broadcast {w2_broadcast:.2f} | reduce_scatter {w2_reduce_scatter:.2f} GB/s</text>
                            </g>
    
                            <!-- Connection lines -->
    {connection_lines}
                        </svg>
                    </div>
                    <p style="margin-top:15px; color:#666; font-size:0.9em">
                        <strong>Legend:</strong> Blue boxes = SR-IOV NICs | Green boxes = NCCL GPU Collective Operations | Arrows = Network connections |
                        Seq = Sequential (one NIC) | Par = Parallel (all NICs) | RoCE+CUDA = GPUDirect RDMA
                    </p>
                </div>"""


    def generate_worker_results(workers, nics, rdma_results, tcp_results, nccl_results, rdma_agg, tcp_agg):
        """Generate per-worker performance results"""

        def get_worker_nccl(worker):
            """Get NCCL results for a specific worker"""
            worker_nccl = [r for r in nccl_results if r['pod'] == worker]
            if not worker_nccl:
                return ""

            rows = ""
            for result in worker_nccl:
                rows += f"""
                                <tr>
                                    <td>{result['test']}</td>
                                    <td>{result['size']}</td>
                                    <td><span class="metric metric-high">{result['bandwidth']:.2f} GB/s</span></td>
                                    <td><span class="status-pass">‚úì {result['status']}</span></td>
                                </tr>"""

            return f"""
                    <h3 style="margin-top: 25px; color: #667eea;">üîÑ NCCL Performance (Local GPU)</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Test</th>
                                <th>Peak Size</th>
                                <th>Peak Bandwidth</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
    {rows}
                        </tbody>
                    </table>"""

        def generate_worker_section(worker, other_workers):
            """Generate performance section for one worker"""
            # For each worker, show its outbound performance to all other workers
            # If only 2 workers total, show direction; otherwise show all targets

            # Determine direction text
            if len(other_workers) == 1:
                direction = f"{worker} ‚Üí {other_workers[0]}"
            else:
                direction = f"{worker} ‚Üí {', '.join(other_workers)}"

            # RDMA Performance
            rdma_rows = ""
            for nic in nics:
                roce_seq = get_rdma_by_nic(rdma_results, nic, 'RoCE_seq')
                roce_par = get_rdma_by_nic(rdma_results, nic, 'RoCE_par')
                cuda_seq = get_rdma_by_nic(rdma_results, nic, 'RoCE_CUDA_seq')
                cuda_par = get_rdma_by_nic(rdma_results, nic, 'RoCE_CUDA_par')

                if roce_seq > 0 or roce_par > 0:
                    rdma_rows += f"""
                                <tr>
                                    <td><strong>{nic}</strong></td>
                                    <td>100G</td>
                                    <td><span class="metric {get_metric_class(roce_seq, 80, 50)}">{roce_seq:.2f} Gb/s</span></td>
                                    <td><span class="metric {get_metric_class(roce_par, 80, 50)}">{roce_par:.2f} Gb/s</span></td>
                                    <td><span class="metric {get_metric_class(cuda_seq, 80, 50)}">{cuda_seq:.2f} Gb/s</span></td>
                                    <td><span class="metric {get_metric_class(cuda_par, 80, 50)}">{cuda_par:.2f} Gb/s</span></td>
                                </tr>"""

            # Add aggregate row
            if rdma_rows:
                rdma_rows += f"""
                                <tr style="background:#f0f0ff; font-weight:bold;">
                                    <td colspan="2" style="text-align:center;">Aggregate:</td>
                                    <td><span class="metric metric-high">{rdma_agg['RoCE_seq']:.2f} Gb/s</span></td>
                                    <td><span class="metric metric-medium">{rdma_agg['RoCE_par']:.2f} Gb/s</span></td>
                                    <td><span class="metric metric-high">{rdma_agg['RoCE_CUDA_seq']:.2f} Gb/s</span></td>
                                    <td><span class="metric metric-medium">{rdma_agg['RoCE_CUDA_par']:.2f} Gb/s</span></td>
                                </tr>"""

            rdma_table = f"""
                    <h3 style="margin-top: 25px; color: #667eea;">‚ö° RDMA Performance (RoCE)</h3>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 10px;">Direction: {direction}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>NIC</th>
                                <th>Link</th>
                                <th>RoCE Sequential</th>
                                <th>RoCE Parallel</th>
                                <th>RoCE+CUDA Seq</th>
                                <th>RoCE+CUDA Par</th>
                            </tr>
                        </thead>
                        <tbody>
    {rdma_rows}
                        </tbody>
                    </table>
                    <p style="margin-top:10px; color:#666; font-size:0.85em">
                        Sequential = one NIC at a time | Parallel = all NICs simultaneously | RoCE+CUDA = GPUDirect RDMA
                    </p>""" if rdma_rows else ""

            # TCP Performance
            tcp_rows = ""
            for nic in nics:
                tcp_result = get_tcp_by_nic(tcp_results, nic)
                tcp_seq = tcp_result.get('tcp_seq', 0)
                tcp_par = tcp_result.get('tcp_par', 0)

                if tcp_seq > 0 or tcp_par > 0:
                    tcp_rows += f"""
                                <tr>
                                    <td><strong>{nic}</strong></td>
                                    <td>100G</td>
                                    <td><span class="metric {get_metric_class(tcp_seq, 80, 50)}">{tcp_seq:.2f} Gb/s</span></td>
                                    <td><span class="metric {get_metric_class(tcp_par, 80, 50)}">{tcp_par:.2f} Gb/s</span></td>
                                </tr>"""

            # Add aggregate row
            if tcp_rows:
                tcp_rows += f"""
                                <tr style="background:#f0f0ff; font-weight:bold;">
                                    <td colspan="2" style="text-align:center;">Aggregate:</td>
                                    <td><span class="metric metric-high">{tcp_agg['tcp_seq']:.2f} Gb/s</span></td>
                                    <td><span class="metric metric-medium">{tcp_agg['tcp_par']:.2f} Gb/s</span></td>
                                </tr>"""

            tcp_table = f"""
                    <h3 style="margin-top: 25px; color: #667eea;">üåê TCP Performance</h3>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 10px;">Direction: {direction}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>NIC</th>
                                <th>Link</th>
                                <th>TCP Sequential</th>
                                <th>TCP Parallel</th>
                            </tr>
                        </thead>
                        <tbody>
    {tcp_rows}
                        </tbody>
                    </table>
                    <p style="margin-top:10px; color:#666; font-size:0.85em">
                        Sequential = one NIC at a time | Parallel = all NICs simultaneously
                    </p>""" if tcp_rows else ""

            nccl_table = get_worker_nccl(worker)

            return f"""<div class="section">
                    <h2>üìä {worker}</h2>
    {rdma_table}
    {tcp_table}
    {nccl_table}
                </div>"""

        # Generate sections for all workers
        all_sections = ""
        for worker in workers:
            # Get list of other workers (all workers except current one)
            other_workers = [w for w in workers if w != worker]
            all_sections += generate_worker_section(worker, other_workers)

        return all_sections


    def generate_rdma_table(rdma_results, rdma_agg, worker1, worker2, nics):
        """Generate RDMA performance table"""
    
        # Build table rows
        rows = ""
        for nic in nics:
            roce_seq = get_rdma_by_nic(rdma_results, nic, 'RoCE_seq')
            roce_par = get_rdma_by_nic(rdma_results, nic, 'RoCE_par')
            cuda_seq = get_rdma_by_nic(rdma_results, nic, 'RoCE_CUDA_seq')
            cuda_par = get_rdma_by_nic(rdma_results, nic, 'RoCE_CUDA_par')
    
            # Determine color coding
            roce_seq_class = get_metric_class(roce_seq, 80, 50)
            roce_par_class = get_metric_class(roce_par, 80, 50)
            cuda_seq_class = get_metric_class(cuda_seq, 80, 50)
            cuda_par_class = get_metric_class(cuda_par, 80, 50)
    
            rows += f"""
                            <tr>
                                <td>{worker1}</td>
                                <td>{worker2}</td>
                                <td><strong>{nic}</strong></td>
                                <td>100G</td>
                                <td><span class="metric {roce_seq_class}">{roce_seq:.2f} Gb/s</span></td>
                                <td><span class="metric {roce_par_class}">{roce_par:.2f} Gb/s</span></td>
                                <td><span class="metric {cuda_seq_class}">{cuda_seq:.2f} Gb/s</span></td>
                                <td><span class="metric {cuda_par_class}">{cuda_par:.2f} Gb/s</span></td>
                            </tr>"""
    
        # Aggregate row
        agg_row = f"""
                            <tr style="background:#f0f0ff; font-weight:bold;">
                                <td colspan="4" style="text-align:center;">Aggregate Bandwidth:</td>
                                <td><span class="metric metric-high">{rdma_agg['RoCE_seq']:.2f} Gb/s</span></td>
                                <td><span class="metric metric-medium">{rdma_agg['RoCE_par']:.2f} Gb/s</span></td>
                                <td><span class="metric metric-high">{rdma_agg['RoCE_CUDA_seq']:.2f} Gb/s</span></td>
                                <td><span class="metric metric-medium">{rdma_agg['RoCE_CUDA_par']:.2f} Gb/s</span></td>
                            </tr>"""
    
        return f"""<div class="section">
                    <h2>‚ö° RDMA Performance (RoCE)</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Source</th>
                                <th>Target</th>
                                <th>NIC</th>
                                <th>Link</th>
                                <th>RoCE Sequential</th>
                                <th>RoCE Parallel</th>
                                <th>RoCE+CUDA Seq</th>
                                <th>RoCE+CUDA Par</th>
                            </tr>
                        </thead>
                        <tbody>
    {rows}
    {agg_row}
                        </tbody>
                    </table>
                    <p style="margin-top:15px; color:#666; font-size:0.85em">
                        <strong>Note:</strong> Sequential = one NIC at a time | Parallel = all NICs simultaneously |
                        RoCE+CUDA = GPUDirect RDMA
                    </p>
                </div>"""
    
    
    def generate_tcp_table(tcp_results, tcp_agg, worker1, worker2, nics):
        """Generate TCP performance table"""
    
        rows = ""
        for nic in nics:
            tcp = get_tcp_by_nic(tcp_results, nic)
            tcp_seq = tcp['tcp_seq']
            tcp_par = tcp['tcp_par']
    
            tcp_seq_class = get_metric_class(tcp_seq, 60, 30)
            tcp_par_class = get_metric_class(tcp_par, 60, 30)
    
            rows += f"""
                            <tr>
                                <td>{worker1}</td>
                                <td>{worker2}</td>
                                <td><strong>{nic}</strong></td>
                                <td>100G</td>
                                <td><span class="metric {tcp_seq_class}">{tcp_seq:.1f} Gb/s</span></td>
                                <td><span class="metric {tcp_par_class}">{tcp_par:.1f} Gb/s</span></td>
                            </tr>"""
    
        agg_row = f"""
                            <tr style="background:#f0f0ff; font-weight:bold;">
                                <td colspan="4" style="text-align:center;">Aggregate Bandwidth:</td>
                                <td><span class="metric metric-high">{tcp_agg['tcp_seq']:.1f} Gb/s</span></td>
                                <td><span class="metric metric-high">{tcp_agg['tcp_par']:.1f} Gb/s</span></td>
                            </tr>"""
    
        return f"""<div class="section">
                    <h2>üåê TCP Performance (iperf3)</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Source</th>
                                <th>Target</th>
                                <th>NIC</th>
                                <th>Link</th>
                                <th>TCP Sequential</th>
                                <th>TCP Parallel</th>
                            </tr>
                        </thead>
                        <tbody>
    {rows}
    {agg_row}
                        </tbody>
                    </table>
                </div>"""
    
    
    def generate_nccl_table(nccl_results):
        """Generate NCCL performance table"""
    
        rows = ""
        for result in nccl_results:
            pod = result['pod']
            gpu = result['gpu']
            test = result['test']
            size = result['size']
            bandwidth = result['bandwidth']
            status = result['status']
    
            status_class = 'status-pass' if status == 'PASS' else 'status-fail'
    
            rows += f"""
                            <tr>
                                <td>{pod}</td>
                                <td>{gpu}</td>
                                <td>{test}</td>
                                <td>20</td>
                                <td>{size}</td>
                                <td><span class="metric metric-high">{bandwidth:.2f} GB/s</span></td>
                                <td><span class="{status_class}">‚úì {status}</span></td>
                            </tr>"""
    
        return f"""<div class="section">
                    <h2>üîÑ NCCL Collective Operations</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Pod</th>
                                <th>GPU Model</th>
                                <th>Test</th>
                                <th>Iterations</th>
                                <th>Peak Size</th>
                                <th>Peak Bandwidth</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
    {rows}
                        </tbody>
                    </table>
                </div>"""
    
    
    def get_metric_class(value, high_threshold, low_threshold):
        """Return CSS class based on value thresholds"""
        if value >= high_threshold:
            return 'metric-high'
        elif value >= low_threshold:
            return 'metric-medium'
        else:
            return 'metric-low'

  circular_topology.py: |
    #!/usr/bin/env python3
    """
    Network Topology with Server Icons - Cytoscape.js Version
    Generates interactive visualization with NIC breakdown for parallel tests
    """
    import json
    import sys
    sys.path.insert(0, '/scripts')
    from parser import collect_all_data

    def generate_circular_topology_html(data):
        """Generate topology using Cytoscape.js with original server icons and full names"""

        workers = data['workers']
        nics = data['nics']
        rdma_results = data['rdma_results']
        tcp_results = data['tcp_results']
        nccl_results = data.get('nccl_results', [])
        multinode_nccl_results = data.get('multinode_nccl_results', [])
        worker_ips = data.get('worker_ips', {})
        worker_routes = data.get('worker_routes', {})
        worker_nic_models = data.get('worker_nic_models', {})
        worker_nic_speeds = data.get('worker_nic_speeds', {})
        hardware = data.get('hardware', {})

        # Build Cytoscape nodes
        cy_nodes = []
        cy_edges = []

        if workers:
            source_node = workers[0]
            source_ips = worker_ips.get(source_node, {})
            source_routes = worker_routes.get(source_node, {})
            source_nic_models = worker_nic_models.get(source_node, {})
            source_nic_speeds = worker_nic_speeds.get(source_node, {})

            source_nccl = {
                'all_reduce': 0,
                'all_gather': 0,
                'reduce_scatter': 0,
                'broadcast': 0
            }
            for result in nccl_results:
                if result['pod'] == source_node:
                    test_name = result['test']
                    source_nccl[test_name] = result.get('bandwidth', 0)

            nic_info = []
            for nic in nics:
                routes = ', '.join(source_routes.get(nic, ['N/A'])[:2])
                model = source_nic_models.get(nic, 'Unknown')[:30]
                speed = source_nic_speeds.get(nic, 'Unknown')
                nic_info.append({
                    'name': nic,
                    'ip': source_ips.get(nic, 'N/A'),
                    'routes': routes,
                    'model': model,
                    'speed': speed
                })

            cy_nodes.append({
                'data': {
                    'id': source_node,
                    'label': source_node,  # Full name
                    'type': 'source',
                    'eth0': source_ips.get('eth0', 'N/A'),
                    'gpu': hardware.get('gpu_model', 'Unknown'),
                    'cpu': hardware.get('cpu_model', 'Unknown').replace('Intel(R) ', '').replace(' CPU @ 2.00GHz', '')[:40],
                    'cores': hardware.get('cpu_cores', 'Unknown'),
                    'nics': json.dumps(nic_info),
                    'nccl': json.dumps(source_nccl)
                }
            })

            # Target nodes
            for i, worker in enumerate(workers[1:], 1):
                worker_ip = worker_ips.get(worker, {})
                worker_route = worker_routes.get(worker, {})
                worker_nic_model = worker_nic_models.get(worker, {})
                worker_nic_speed = worker_nic_speeds.get(worker, {})

                target_nccl = {
                    'all_reduce': 0,
                    'all_gather': 0,
                    'reduce_scatter': 0,
                    'broadcast': 0
                }
                for result in nccl_results:
                    if result['pod'] == worker:
                        test_name = result['test']
                        target_nccl[test_name] = result.get('bandwidth', 0)

                nic_info = []
                for nic in nics:
                    routes = ', '.join(worker_route.get(nic, ['N/A'])[:2])
                    model = worker_nic_model.get(nic, 'Unknown')[:30]
                    speed = worker_nic_speed.get(nic, 'Unknown')
                    nic_info.append({
                        'name': nic,
                        'ip': worker_ip.get(nic, 'N/A'),
                        'routes': routes,
                        'model': model,
                        'speed': speed
                    })

                cy_nodes.append({
                    'data': {
                        'id': worker,
                        'label': worker,  # Full name
                        'type': 'target',
                        'eth0': worker_ip.get('eth0', 'N/A'),
                        'gpu': hardware.get('gpu_model', 'Unknown'),
                        'cpu': hardware.get('cpu_model', 'Unknown').replace('Intel(R) ', '').replace(' CPU @ 2.00GHz', '')[:40],
                        'cores': hardware.get('cpu_cores', 'Unknown'),
                        'nics': json.dumps(nic_info),
                        'nccl': json.dumps(target_nccl)
                    }
                })

                # Create individual NIC edges (sequential only)
                for nic_idx, nic in enumerate(nics):
                    roce_seq = 0
                    cuda_seq = 0
                    tcp_seq = 0

                    for result in rdma_results:
                        if result['source'] == source_node and result['target'] == worker and result['nic'] == nic:
                            if result['type'] == 'RoCE_seq':
                                roce_seq = result['bandwidth']
                            elif result['type'] == 'RoCE_CUDA_seq':
                                cuda_seq = result['bandwidth']

                    for result in tcp_results:
                        if result['source'] == source_node and result['target'] == worker and result['nic'] == nic:
                            tcp_seq = result.get('tcp_seq', 0)

                    # Get NIC speed
                    nic_speed = worker_nic_speed.get(nic, 'Unknown')

                    if roce_seq > 0 or cuda_seq > 0 or tcp_seq > 0:
                        cy_edges.append({
                            'data': {
                                'id': f"{source_node}-{worker}-{nic}",
                                'source': source_node,
                                'target': worker,
                                'nic': nic,
                                'nicIndex': nic_idx,
                                'edgeType': 'individual',
                                'roce_seq': roce_seq,
                                'cuda_seq': cuda_seq,
                                'tcp_seq': tcp_seq,
                                'nic_speed': nic_speed,
                                'bandwidth': roce_seq,
                                'label': f"{nic}"
                            }
                        })

                # Create aggregate edge for parallel data (sum of all NICs)
                total_roce_par = 0
                total_cuda_par = 0
                total_tcp_par = 0

                # Track individual NIC contributions
                roce_par_nics = {}
                cuda_par_nics = {}
                tcp_par_nics = {}

                for result in rdma_results:
                    if result['source'] == source_node and result['target'] == worker:
                        if result['type'] == 'RoCE_par':
                            total_roce_par += result['bandwidth']
                            roce_par_nics[result['nic']] = result['bandwidth']
                        elif result['type'] == 'RoCE_CUDA_par':
                            total_cuda_par += result['bandwidth']
                            cuda_par_nics[result['nic']] = result['bandwidth']

                for result in tcp_results:
                    if result['source'] == source_node and result['target'] == worker:
                        tcp_par_val = result.get('tcp_par', 0)
                        total_tcp_par += tcp_par_val
                        if tcp_par_val > 0:
                            tcp_par_nics[result['nic']] = tcp_par_val

                if total_roce_par > 0 or total_cuda_par > 0 or total_tcp_par > 0:
                    cy_edges.append({
                        'data': {
                            'id': f"{source_node}-{worker}-aggregate",
                            'source': source_node,
                            'target': worker,
                            'nic': 'ALL NICs',
                            'nicIndex': len(nics),  # Put it last
                            'edgeType': 'aggregate',
                            'roce_par': total_roce_par,
                            'cuda_par': total_cuda_par,
                            'tcp_par': total_tcp_par,
                            'roce_par_nics': json.dumps(roce_par_nics),
                            'cuda_par_nics': json.dumps(cuda_par_nics),
                            'tcp_par_nics': json.dumps(tcp_par_nics),
                            'bandwidth': total_roce_par,
                            'label': 'ALL (Parallel)'
                        }
                    })

        cy_elements = {'nodes': cy_nodes, 'edges': cy_edges}
        cy_data = json.dumps(cy_elements)
        multinode_nccl_data = json.dumps(multinode_nccl_results)

        html = f"""<!DOCTYPE html>
    <html>
    <head>
        <title>Network Topology - Server Icons</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <style>
            * {{ margin: 0; padding: 0; box-sizing: border-box; }}
            body {{
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }}
            .container {{
                max-width: 98%;
                margin: 0 auto;
                background: white;
                border-radius: 12px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                overflow: hidden;
            }}
            .header {{
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                text-align: center;
            }}
            .header h1 {{ font-size: 2.2em; margin-bottom: 10px; }}
            .controls {{
                background: #f8f9fa;
                padding: 20px;
                border-bottom: 1px solid #ddd;
                display: flex;
                gap: 15px;
                flex-wrap: wrap;
                align-items: center;
            }}
            .btn {{
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: transform 0.2s, box-shadow 0.2s;
            }}
            .btn:hover {{
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }}
            #cy {{
                width: 100%;
                height: 800px;
                background: #fafafa;
            }}
            .info-panel {{
                position: absolute;
                top: 120px;
                right: 30px;
                width: 320px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                padding: 15px;
                max-height: 85vh;
                overflow-y: auto;
                display: none;
                z-index: 1000;
            }}
            .info-panel.visible {{
                display: block;
            }}
            .info-panel h3 {{
                color: #667eea;
                margin-bottom: 10px;
                font-size: 16px;
            }}
            .info-panel .close-btn {{
                position: absolute;
                top: 10px;
                right: 10px;
                background: none;
                border: none;
                font-size: 20px;
                cursor: pointer;
                color: #999;
            }}
            .info-item {{
                margin: 8px 0;
                font-size: 12px;
                padding: 8px;
                background: #f8f9fa;
                border-radius: 4px;
            }}
            .info-item strong {{
                color: #667eea;
            }}
            .multinode-nccl {{
                background: #fff3e0;
                padding: 15px;
                margin: 20px;
                border-left: 4px solid #ff9800;
                border-radius: 4px;
            }}
            .multinode-nccl h3 {{
                color: #e65100;
                margin-bottom: 10px;
            }}
            .nccl-item {{
                font-size: 13px;
                margin: 5px 0;
                padding: 5px;
                background: white;
                border-radius: 4px;
            }}
            .legend {{
                background: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                margin: 20px;
            }}
            .legend-item {{
                display: flex;
                align-items: center;
                margin: 8px 0;
                font-size: 14px;
            }}
            .info-text {{
                background: #e3f2fd;
                padding: 10px;
                margin: 20px;
                border-left: 4px solid #2196f3;
                border-radius: 4px;
                font-size: 13px;
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üñ•Ô∏è Network Topology - Server View</h1>
                <p>Professional network visualization with server icons</p>
            </div>

            <div class="controls">
                <button class="btn" onclick="resetView()">üîÑ Reset View</button>
                <button class="btn" onclick="cy.zoom(cy.zoom() * 1.2); cy.center()">üîç+ Zoom In</button>
                <button class="btn" onclick="cy.zoom(cy.zoom() * 0.8); cy.center()">üîç- Zoom Out</button>
                <button class="btn" onclick="fitToScreen()">üìê Fit to Screen</button>
                <button class="btn" onclick="exportPNG()">üì∏ Export PNG</button>
                <button class="btn" onclick="exportJSON()">üíæ Export JSON</button>
                <button class="btn" onclick="exportHTML()">üìÑ Export HTML</button>
            </div>

            <div class="info-text">
                <strong>üí° Controls:</strong>
                Scroll to zoom | Drag background to pan | <strong>Drag server icons to move</strong> |
                Click server for details | <strong>Double-click canvas to reset zoom</strong> | <strong>Drag to box-select and zoom</strong>
            </div>

            <div style="position: relative;">
                <div id="cy"></div>
                <div id="info-panel" class="info-panel">
                    <button class="close-btn" onclick="closeInfo()">‚úï</button>
                    <div id="info-content"></div>
                </div>
            </div>

            <div class="legend">
                <h3 style="margin-bottom: 10px;">Legend</h3>
                <div class="legend-item">
                    <i class="fas fa-server" style="color: #667eea; font-size: 20px; margin-right: 10px;"></i>
                    <span>Source server (center) - drag to reposition</span>
                </div>
                <div class="legend-item">
                    <i class="fas fa-server" style="color: #2196f3; font-size: 20px; margin-right: 10px;"></i>
                    <span>Target servers - drag to reposition</span>
                </div>
                <div class="legend-item">
                    <div style="width: 40px; height: 3px; background: #00c853; margin-right: 10px;"></div>
                    <span>Individual NIC (Sequential) - Excellent (‚â•90% of NIC speed)</span>
                </div>
                <div class="legend-item">
                    <div style="width: 40px; height: 3px; background: #ffd600; margin-right: 10px;"></div>
                    <span>Individual NIC (Sequential) - Good (70-90% of NIC speed)</span>
                </div>
                <div class="legend-item">
                    <div style="width: 40px; height: 3px; background: #ff1744; margin-right: 10px;"></div>
                    <span>Individual NIC (Sequential) - Needs Investigation (<70% of NIC speed)</span>
                </div>
                <div class="legend-item">
                    <div style="width: 40px; height: 3px; background: #ff9800; border-top: 3px dashed #ff9800; margin-right: 10px;"></div>
                    <span><strong>ALL NICs (Parallel)</strong> - Combined throughput of all NICs</span>
                </div>
            </div>
        </div>

        <script>
            const elements = {cy_data};
            const multinodeNccl = {multinode_nccl_data};

            const nicColors = ['#2196f3', '#ff9800', '#9c27b0', '#4caf50', '#e91e63', '#00bcd4'];

            // Convert NIC speed from Mb/s to Gb/s
            function formatNicSpeed(speed) {{
                if (speed === 'Unknown') return 'Unknown';
                const match = speed.match(/(\d+)Mb\/s/);
                if (match) {{
                    const mbps = parseInt(match[1]);
                    const gbps = mbps / 1000;
                    return `${{speed}} (${{gbps}} Gb/s)`;
                }}
                return speed;
            }}

            function formatBreakdown(nicsJson, total) {{
                if (!nicsJson || nicsJson === '{{}}') {{
                    return `<strong>Total Bandwidth:</strong> ${{total.toFixed(2)}} Gb/s`;
                }}

                try {{
                    const nics = JSON.parse(nicsJson);
                    const nicEntries = Object.entries(nics);

                    if (nicEntries.length === 0) {{
                        return `<strong>Total Bandwidth:</strong> ${{total.toFixed(2)}} Gb/s`;
                    }}

                    const parts = nicEntries.map(([nic, bw]) => `${{bw.toFixed(2)}}G (${{nic}})`);
                    const breakdown = parts.join(' + ');
                    return `<strong>Breakdown:</strong> ${{breakdown}} = ${{total.toFixed(2)}} Gb/s`;
                }} catch (e) {{
                    return `<strong>Total Bandwidth:</strong> ${{total.toFixed(2)}} Gb/s`;
                }}
            }}

            function calculateUtilization(bandwidth, nicSpeed) {{
                if (!nicSpeed || nicSpeed === 'Unknown' || bandwidth === 0) {{
                    return null;
                }}

                const match = nicSpeed.match(/(\\d+)Mb\\/s/);
                if (match) {{
                    const nicSpeedGbps = parseInt(match[1]) / 1000;
                    const utilization = (bandwidth / nicSpeedGbps) * 100;
                    return utilization.toFixed(1);
                }}
                return null;
            }}

            function formatUtilization(bandwidth, nicSpeed) {{
                const util = calculateUtilization(bandwidth, nicSpeed);
                if (util === null) return '';

                let color = '#ff1744';  // Red
                if (util >= 90) color = '#00c853';  // Green
                else if (util >= 70) color = '#ffd600';  // Yellow

                return `<div style="margin-top: 5px; padding: 5px; background: ${{color}}22; border-left: 3px solid ${{color}};">
                    <strong>Utilization:</strong> ${{util}}% of NIC capability
                </div>`;
            }}

            // Server rack icon with WHITE background
            function createServerIcon(color, isSource) {{
                const size = isSource ? 80 : 60;
                const svg = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="${{size}}" height="${{size}}">
                        <!-- White background to prevent black showing through -->
                        <rect x="0" y="0" width="24" height="24" fill="white" rx="2"/>

                        <!-- Server rack units -->
                        <rect x="2" y="3" width="20" height="6" rx="1.5" fill="${{color}}" stroke="white" stroke-width="0.3"/>
                        <rect x="2" y="10" width="20" height="6" rx="1.5" fill="${{color}}" stroke="white" stroke-width="0.3"/>
                        <rect x="2" y="17" width="20" height="4" rx="1.5" fill="${{color}}" stroke="white" stroke-width="0.3"/>

                        <!-- Status LEDs -->
                        <circle cx="5" cy="6" r="0.8" fill="#4caf50"/>
                        <circle cx="7" cy="6" r="0.8" fill="#ffd600"/>
                        <circle cx="5" cy="13" r="0.8" fill="#4caf50"/>
                        <circle cx="7" cy="13" r="0.8" fill="#4caf50"/>
                        <circle cx="5" cy="19" r="0.6" fill="#4caf50"/>

                        <!-- Drive bays -->
                        <rect x="10" y="5" width="8" height="2" rx="0.4" fill="white" opacity="0.5"/>
                        <rect x="10" y="12" width="8" height="2" rx="0.4" fill="white" opacity="0.5"/>
                        <rect x="10" y="18" width="6" height="1.5" rx="0.4" fill="white" opacity="0.5"/>
                    </svg>
                `;
                return 'data:image/svg+xml;base64,' + btoa(svg);
            }}

            const cy = cytoscape({{
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    {{
                        selector: 'node',
                        style: {{
                            'shape': 'rectangle',
                            'background-image': ele => createServerIcon('#2196f3', false),
                            'background-fit': 'contain',
                            'background-clip': 'none',
                            'background-color': 'transparent',
                            'label': 'data(label)',
                            'width': 80,
                            'height': 80,
                            'font-size': 11,
                            'text-valign': 'bottom',
                            'text-halign': 'center',
                            'text-margin-y': 5,
                            'color': '#333',
                            'font-weight': 'bold',
                            'overlay-opacity': 0,
                            'border-width': 0,
                            'text-wrap': 'wrap',
                            'text-max-width': 140
                        }}
                    }},
                    {{
                        selector: 'node[type="source"]',
                        style: {{
                            'background-image': ele => createServerIcon('#667eea', true),
                            'width': 100,
                            'height': 100,
                            'font-size': 12
                        }}
                    }},
                    {{
                        selector: 'node:selected',
                        style: {{
                            'border-width': 3,
                            'border-color': '#ff9800',
                            'border-opacity': 1
                        }}
                    }},
                    {{
                        selector: 'edge',
                        style: {{
                            'width': 'mapData(bandwidth, 0, 100, 2, 8)',
                            'line-color': ele => {{
                                // Calculate percentage of NIC capability
                                const bw = ele.data('bandwidth');
                                const nicSpeed = ele.data('nic_speed');

                                if (!nicSpeed || nicSpeed === 'Unknown') {{
                                    // Fallback to absolute values if NIC speed unknown
                                    if (bw > 80) return '#00c853';
                                    if (bw > 40) return '#ffd600';
                                    return '#ff1744';
                                }}

                                // Parse NIC speed (e.g., "100000Mb/s" -> 100 Gb/s)
                                const match = nicSpeed.match(/(\\d+)Mb\\/s/);
                                if (match) {{
                                    const nicSpeedGbps = parseInt(match[1]) / 1000;
                                    const utilization = (bw / nicSpeedGbps) * 100;

                                    if (utilization >= 90) return '#00c853';  // Green: 90-100%
                                    if (utilization >= 70) return '#ffd600';  // Yellow: 70-90%
                                    return '#ff1744';  // Red: <70%
                                }}

                                // Fallback
                                if (bw > 80) return '#00c853';
                                if (bw > 40) return '#ffd600';
                                return '#ff1744';
                            }},
                            'target-arrow-color': ele => {{
                                const nicIdx = ele.data('nicIndex');
                                return nicColors[nicIdx % nicColors.length];
                            }},
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'label': 'data(label)',
                            'font-size': 16,
                            'text-rotation': 'autorotate',
                            'text-margin-y': -10,
                            'color': '#333',
                            'font-weight': 'bold',
                            'opacity': 0.8
                        }}
                    }},
                    {{
                        selector: 'edge:selected',
                        style: {{
                            'width': 'mapData(bandwidth, 0, 100, 4, 12)',
                            'opacity': 1
                        }}
                    }},
                    {{
                        selector: 'edge[edgeType="aggregate"]',
                        style: {{
                            'line-style': 'dashed',
                            'line-dash-pattern': [10, 5],
                            'width': 6,
                            'line-color': '#ff9800',
                            'target-arrow-color': '#ff9800',
                            'font-size': 16,
                            'font-weight': 'bold',
                            'color': '#333'
                        }}
                    }}
                ],
                layout: {{
                    name: 'circle',
                    radius: 300,
                    startAngle: -Math.PI / 2,
                    animate: true,
                    animationDuration: 500
                }},
                wheelSensitivity: 0.2,
                minZoom: 0.1,
                maxZoom: 5,
                // Enable box selection WITHOUT requiring Shift key
                boxSelectionEnabled: true,
                selectionType: 'additive'
            }});

            // Click node to show info
            cy.on('tap', 'node', function(evt) {{
                const node = evt.target;
                const data = node.data();
                const nics = JSON.parse(data.nics);
                const ncclData = JSON.parse(data.nccl);

                let html = `
                    <h3><i class="fas fa-server"></i> ${{data.label}}</h3>
                    <div class="info-item"><strong>CPU:</strong> ${{data.cpu}} (${{data.cores}} cores)</div>
                    <div class="info-item"><strong>GPU:</strong> ${{data.gpu}}</div>
                    <div class="info-item"><strong>eth0:</strong> ${{data.eth0}}</div>
                    <h4 style="margin-top: 15px; color: #667eea;">Network Interfaces</h4>
                `;

                nics.forEach((nic, idx) => {{
                    const color = nicColors[idx % nicColors.length];
                    html += `
                        <div class="info-item" style="border-left: 4px solid ${{color}};">
                            <strong>${{nic.name}}</strong><br>
                            Speed: ${{formatNicSpeed(nic.speed)}}<br>
                            IP: ${{nic.ip}}<br>
                            Routes: ${{nic.routes}}<br>
                            Model: ${{nic.model}}
                        </div>
                    `;
                }});

                // Add Local NCCL Performance section
                html += `<h4 style="margin-top: 15px; color: #667eea;">Local NCCL Performance</h4>`;

                if (ncclData.all_reduce > 0 || ncclData.all_gather > 0 || ncclData.reduce_scatter > 0 || ncclData.broadcast > 0) {{
                    html += `
                        <div class="info-item" style="background: #fff3e0; border-left: 4px solid #ff9800;">
                            <strong>all_reduce:</strong> ${{ncclData.all_reduce.toFixed(2)}} GB/s<br>
                            <strong>all_gather:</strong> ${{ncclData.all_gather.toFixed(2)}} GB/s<br>
                            <strong>reduce_scatter:</strong> ${{ncclData.reduce_scatter.toFixed(2)}} GB/s<br>
                            <strong>broadcast:</strong> ${{ncclData.broadcast.toFixed(2)}} GB/s
                        </div>
                    `;
                }} else {{
                    html += `<div class="info-item"><em>No local NCCL data available</em></div>`;
                }}

                document.getElementById('info-content').innerHTML = html;
                document.getElementById('info-panel').classList.add('visible');
            }});

            // Click edge to show connection details
            cy.on('tap', 'edge', function(evt) {{
                const edge = evt.target;
                const data = edge.data();
                let html = '';

                if (data.edgeType === 'individual') {{
                    // Individual NIC - show sequential data only
                    html = `
                        <h3><i class="fas fa-network-wired"></i> ${{data.nic}} Connection</h3>
                        <div class="info-item">
                            <strong>Source:</strong> ${{data.source}}<br>
                            <strong>Target:</strong> ${{data.target}}<br>
                            <strong>Type:</strong> Individual NIC (Sequential)<br>
                            <strong>Auto-negotiated Speed:</strong> ${{formatNicSpeed(data.nic_speed)}}
                        </div>

                        <h4 style="margin-top: 15px; color: #667eea;">
                            <i class="fas fa-chart-line"></i> TCP Sequential Performance
                        </h4>
                        <div class="info-item" style="background: #e3f2fd; border-left: 4px solid #2196f3;">
                            <strong>Bandwidth:</strong> ${{data.tcp_seq.toFixed(2)}} Gb/s
                            ${{formatUtilization(data.tcp_seq, data.nic_speed)}}
                        </div>

                        <h4 style="margin-top: 15px; color: #667eea;">
                            <i class="fas fa-bolt"></i> RDMA (RoCE) Sequential Performance
                        </h4>
                        <div class="info-item" style="background: #f3e5f5; border-left: 4px solid #9c27b0;">
                            <strong>Bandwidth:</strong> ${{data.roce_seq.toFixed(2)}} Gb/s
                            ${{formatUtilization(data.roce_seq, data.nic_speed)}}
                        </div>

                        <h4 style="margin-top: 15px; color: #667eea;">
                            <i class="fas fa-microchip"></i> RoCE+CUDA (GPUDirect) Sequential
                        </h4>
                        <div class="info-item" style="background: #e8f5e9; border-left: 4px solid #4caf50;">
                            <strong>Bandwidth:</strong> ${{data.cuda_seq.toFixed(2)}} Gb/s
                            ${{formatUtilization(data.cuda_seq, data.nic_speed)}}
                        </div>
                    `;
                }} else {{
                    // Aggregate - show parallel data (sum of all NICs)
                    html = `
                        <h3><i class="fas fa-project-diagram"></i> Aggregate Connection</h3>
                        <div class="info-item">
                            <strong>Source:</strong> ${{data.source}}<br>
                            <strong>Target:</strong> ${{data.target}}<br>
                            <strong>Type:</strong> All NICs Combined (Parallel)
                        </div>

                        <h4 style="margin-top: 15px; color: #667eea;">
                            <i class="fas fa-chart-line"></i> TCP Parallel Performance
                        </h4>
                        <div class="info-item" style="background: #e3f2fd; border-left: 4px solid #2196f3;">
                            ${{formatBreakdown(data.tcp_par_nics, data.tcp_par)}}
                        </div>

                        <h4 style="margin-top: 15px; color: #667eea;">
                            <i class="fas fa-bolt"></i> RDMA (RoCE) Parallel Performance
                        </h4>
                        <div class="info-item" style="background: #f3e5f5; border-left: 4px solid #9c27b0;">
                            ${{formatBreakdown(data.roce_par_nics, data.roce_par)}}
                        </div>

                        <h4 style="margin-top: 15px; color: #667eea;">
                            <i class="fas fa-microchip"></i> RoCE+CUDA (GPUDirect) Parallel
                        </h4>
                        <div class="info-item" style="background: #e8f5e9; border-left: 4px solid #4caf50;">
                            ${{formatBreakdown(data.cuda_par_nics, data.cuda_par)}}
                        </div>

                        <div class="info-item" style="background: #fff3e0; border-left: 4px solid #ff9800; margin-top: 15px;">
                            <i class="fas fa-info-circle"></i>
                            <strong>Note:</strong> Parallel tests use all NICs simultaneously, so this represents the combined throughput.
                        </div>
                    `;

                    // Add Multi-Node NCCL Performance section to aggregate line
                    if (multinodeNccl.length > 0) {{
                        html += `<h4 style="margin-top: 15px; color: #667eea;"><i class="fas fa-network-wired"></i> Multi-Node NCCL Performance</h4>`;
                        multinodeNccl.forEach(result => {{
                            html += `
                                <div class="info-item" style="background: #e8f5e9; border-left: 4px solid #4caf50;">
                                    <strong>${{result.size}}:</strong> ${{result.bandwidth.toFixed(2)}} Gb/s
                                    <span style="color: #4caf50;">‚úì ${{result.status}}</span>
                                </div>
                            `;
                        }});
                    }}
                }}

                document.getElementById('info-content').innerHTML = html;
                document.getElementById('info-panel').classList.add('visible');
            }});

            // Double-click on canvas (background) to reset zoom and fit
            cy.on('dbltap', function(evt) {{
                // Only reset if clicked on background, not on a node or edge
                if (evt.target === cy) {{
                    cy.fit();
                    cy.center();
                }}
            }});

            // Box selection zoom: when nodes are selected via box-select, zoom to fit them
            cy.on('boxend', function(evt) {{
                const selectedNodes = cy.$(':selected');
                if (selectedNodes.length > 0) {{
                    cy.fit(selectedNodes, 50); // Fit with 50px padding
                    // Deselect after zoom
                    setTimeout(() => selectedNodes.unselect(), 500);
                }}
            }});

            function closeInfo() {{
                document.getElementById('info-panel').classList.remove('visible');
            }}

            function resetView() {{
                cy.layout({{
                    name: 'circle',
                    radius: 300,
                    startAngle: -Math.PI / 2,
                    animate: true,
                    animationDuration: 500
                }}).run();
                cy.fit();
            }}

            function fitToScreen() {{
                cy.fit();
            }}

            function exportPNG() {{
                const png = cy.png({{
                    output: 'blob',
                    bg: '#fafafa',
                    full: true,
                    scale: 4
                }});

                const url = URL.createObjectURL(png);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'network-topology-servers.png';
                link.click();
                URL.revokeObjectURL(url);
            }}

            function exportJSON() {{
                const json = cy.json();
                const blob = new Blob([JSON.stringify(json, null, 2)], {{type: 'application/json'}});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'network-topology.json';
                link.click();
                URL.revokeObjectURL(url);
            }}

            function exportHTML() {{
                // Clone the entire document
                const docClone = document.documentElement.cloneNode(true);

                // Find the #cy container in the clone and reset it to empty state
                const cyClone = docClone.querySelector('#cy');
                if (cyClone) {{
                    // Remove all Cytoscape-generated content (canvas elements, etc.)
                    cyClone.innerHTML = '';
                    // Remove Cytoscape classes
                    cyClone.className = '';
                }}

                // Hide info panel in the clone
                const infoPanelClone = docClone.querySelector('#info-panel');
                if (infoPanelClone) {{
                    infoPanelClone.classList.remove('visible');
                    infoPanelClone.style.display = 'none';
                    // Also clear its content
                    const infoContentClone = infoPanelClone.querySelector('#info-content');
                    if (infoContentClone) {{
                        infoContentClone.innerHTML = '';
                    }}
                }}

                // Get the cleaned HTML
                const htmlContent = '<!DOCTYPE html>\\n' + docClone.outerHTML;
                const blob = new Blob([htmlContent], {{type: 'text/html'}});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'network-topology-complete.html';
                link.click();
                URL.revokeObjectURL(url);
            }}

            cy.ready(function() {{
                cy.fit();
            }});
        </script>
    </body>
    </html>"""

        return html

  generate-report.py: |
    #!/usr/bin/env python3
    import sys
    import os
    import parser
    import html_generator
    import circular_topology

    def main():
        """Main function to generate the report"""
        # Collect data from logs
        data = parser.collect_all_data()

        if not data:
            print("\nERROR: Failed to collect data from logs")
            sys.exit(1)

        # Generate HTML reports
        html = html_generator.generate_html(data)
        circular_html = circular_topology.generate_circular_topology_html(data)

        # Save to files
        output_dir = "/tmp/www"
        os.makedirs(output_dir, exist_ok=True)

        # Main report (with tables and old topology)
        with open(f"{output_dir}/index.html", "w") as f:
            f.write(html)

        # Circular topology visualization
        with open(f"{output_dir}/topology.html", "w") as f:
            f.write(circular_html)

        # Create landing page with navigation
        landing_html = f"""<!DOCTYPE html>
    <html>
    <head>
        <title>Network Performance Report</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            * {{ margin: 0; padding: 0; box-sizing: border-box; }}
            body {{
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }}
            .container {{
                max-width: 900px;
                background: white;
                border-radius: 12px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                overflow: hidden;
            }}
            .header {{
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 40px;
                text-align: center;
            }}
            .header h1 {{ font-size: 2.5em; margin-bottom: 10px; }}
            .content {{ padding: 40px; }}
            .card-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }}
            .card {{
                background: #f8f9fa;
                padding: 30px;
                border-radius: 10px;
                text-align: center;
                transition: transform 0.2s, box-shadow 0.2s;
                cursor: pointer;
                text-decoration: none;
                color: inherit;
                display: block;
            }}
            .card:hover {{
                transform: translateY(-5px);
                box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            }}
            .card-icon {{
                font-size: 3em;
                margin-bottom: 15px;
            }}
            .card h2 {{
                color: #667eea;
                margin-bottom: 10px;
                font-size: 1.5em;
            }}
            .card p {{
                color: #666;
                line-height: 1.6;
            }}
            .stats {{
                background: #e3f2fd;
                padding: 20px;
                border-radius: 8px;
                margin: 20px 0;
            }}
            .stats-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                margin-top: 15px;
            }}
            .stat-item {{
                text-align: center;
            }}
            .stat-value {{
                font-size: 2em;
                font-weight: bold;
                color: #667eea;
            }}
            .stat-label {{
                color: #666;
                font-size: 0.9em;
                margin-top: 5px;
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üöÄ Network Performance Report</h1>
                <p>Comprehensive RDMA, TCP, and NCCL Analysis</p>
            </div>

            <div class="content">
                <div class="stats">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Test Summary</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">{len(data['workers'])}</div>
                            <div class="stat-label">Worker Nodes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{len(data['nics'])}</div>
                            <div class="stat-label">SR-IOV NICs</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{len(data['rdma_results'])}</div>
                            <div class="stat-label">RDMA Tests</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{len(data['nccl_results'])}</div>
                            <div class="stat-label">NCCL Tests</div>
                        </div>
                    </div>
                </div>

                <div class="card-grid">
                    <a href="topology.html" class="card">
                        <div class="card-icon">üîó</div>
                        <h2>Network Topology</h2>
                        <p>Interactive network visualization with zoom, pan, and export capabilities</p>
                    </a>

                    <a href="details.html" class="card">
                        <div class="card-icon">üìä</div>
                        <h2>Detailed Results</h2>
                        <p>Performance tables, hardware specs, and comprehensive test results</p>
                    </a>
                </div>
            </div>
        </div>
    </body>
    </html>"""

        with open(f"{output_dir}/landing.html", "w") as f:
            f.write(landing_html)

        # Rename detailed report
        os.rename(f"{output_dir}/index.html", f"{output_dir}/details.html")

        # Make landing page the index
        with open(f"{output_dir}/index.html", "w") as f:
            f.write(landing_html)

        print(f"\n‚úì HTML reports generated successfully!")
        print(f"  Landing page: {output_dir}/index.html")
        print(f"  Circular topology: {output_dir}/topology.html")
        print(f"  Detailed results: {output_dir}/details.html")
        print(f"  Total size: {len(html) + len(circular_html) + len(landing_html)} bytes")

    if __name__ == "__main__":
        main()
